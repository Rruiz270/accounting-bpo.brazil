// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// CORE MODELS
// =====================================================

model Tenant {
  id                    String   @id @default(uuid()) @db.Uuid
  slug                  String   @unique @db.VarChar(50)
  companyName           String   @map("company_name") @db.VarChar(255)
  tradeName             String?  @map("trade_name") @db.VarChar(255)
  cnpj                  String   @unique @db.VarChar(14)
  stateRegistration     String?  @map("state_registration") @db.VarChar(20)
  cityRegistration      String?  @map("city_registration") @db.VarChar(20)
  address               Json?    @db.JsonB
  contactInfo           Json?    @map("contact_info") @db.JsonB
  dominioApiKey         String?  @map("dominio_api_key") @db.VarChar(255)
  dominioCompanyId      String?  @map("dominio_company_id") @db.VarChar(50)
  subscriptionPlan      String   @default("basic") @map("subscription_plan") @db.VarChar(50)
  subscriptionStatus    String   @default("active") @map("subscription_status") @db.VarChar(20)
  settings              Json     @default("{}") @db.JsonB
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  isActive              Boolean  @default(true) @map("is_active")

  // Relations
  userTenants           UserTenant[]
  suppliers             Supplier[]
  customers             Customer[]
  accountsPayable       AccountPayable[]
  accountsReceivable    AccountReceivable[]
  bankAccounts          BankAccount[]
  cashFlowEntries       CashFlowEntry[]
  cashFlowProjections   CashFlowProjection[]
  bankTransfers         BankTransfer[]
  bankStatements        BankStatement[]
  bankTransactions      BankTransaction[]
  reconciliationRules   ReconciliationRule[]
  categories            Category[]
  attachments           Attachment[]
  auditLogs             AuditLog[]
  notifications         Notification[]
  purchaseInvoices      PurchaseInvoice[]
  salesInvoices         SalesInvoice[]
  bankSlips             BankSlip[]
  paymentSchedules      PaymentSchedule[]

  @@map("tenants")
}

model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique @db.VarChar(255)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  fullName      String    @map("full_name") @db.VarChar(255)
  cpf           String?   @db.VarChar(11)
  phone         String?   @db.VarChar(20)
  avatarUrl     String?   @map("avatar_url") @db.VarChar(500)
  isSuperAdmin  Boolean   @default(false) @map("is_super_admin")
  lastLoginAt   DateTime? @map("last_login_at") @db.Timestamptz(6)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  isActive      Boolean   @default(true) @map("is_active")

  // Relations
  userTenants           UserTenant[]
  createdAccountsPayable AccountPayable[] @relation("AccountPayableCreatedBy")
  updatedAccountsPayable AccountPayable[] @relation("AccountPayableUpdatedBy")
  createdAccountsReceivable AccountReceivable[] @relation("AccountReceivableCreatedBy")
  createdCashFlowEntries CashFlowEntry[]
  createdBankTransfers  BankTransfer[]
  importedBankStatements BankStatement[]
  reconciledTransactions BankTransaction[]
  createdReconciliationRules ReconciliationRule[]
  uploadedAttachments   Attachment[]
  auditLogs             AuditLog[]
  notifications         Notification[]
  createdPurchaseInvoices PurchaseInvoice[]
  createdSalesInvoices  SalesInvoice[]
  createdPaymentSchedules PaymentSchedule[]

  @@map("users")
}

model UserTenant {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  role        String   @db.VarChar(50) // admin, financial_manager, operator, viewer
  permissions Json     @default("[]") @db.JsonB
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy   String?  @map("created_by") @db.Uuid

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@map("user_tenants")
}

// =====================================================
// ACCOUNTS PAYABLE MODULE
// =====================================================

model Supplier {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  supplierType      String   @map("supplier_type") @db.VarChar(20) // company, individual
  cnpjCpf           String   @map("cnpj_cpf") @db.VarChar(14)
  name              String   @db.VarChar(255)
  tradeName         String?  @map("trade_name") @db.VarChar(255)
  stateRegistration String?  @map("state_registration") @db.VarChar(20)
  cityRegistration  String?  @map("city_registration") @db.VarChar(20)
  address           Json?    @db.JsonB
  contactInfo       Json?    @map("contact_info") @db.JsonB
  bankAccounts      Json     @default("[]") @map("bank_accounts") @db.JsonB
  paymentTerms      Int      @default(30) @map("payment_terms")
  notes             String?
  tags              String[] @default([])
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  isActive          Boolean  @default(true) @map("is_active")

  // Relations
  tenant              Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  accountsPayable     AccountPayable[]
  purchaseInvoices    PurchaseInvoice[]

  @@unique([tenantId, cnpjCpf])
  @@map("suppliers")
}

model PurchaseInvoice {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  supplierId   String?  @map("supplier_id") @db.Uuid
  invoiceNumber String  @map("invoice_number") @db.VarChar(50)
  series       String?  @db.VarChar(10)
  nfeKey       String?  @unique @map("nfe_key") @db.VarChar(44)
  issueDate    DateTime @map("issue_date") @db.Date
  entryDate    DateTime @default(now()) @map("entry_date") @db.Date
  totalAmount  Decimal  @map("total_amount") @db.Decimal(15, 2)
  discountAmount Decimal @default(0) @map("discount_amount") @db.Decimal(15, 2)
  netAmount    Decimal  @map("net_amount") @db.Decimal(15, 2)
  taxDetails   Json?    @map("tax_details") @db.JsonB
  invoiceType  String?  @map("invoice_type") @db.VarChar(50)
  xmlContent   String?  @map("xml_content")
  pdfUrl       String?  @map("pdf_url") @db.VarChar(500)
  status       String   @default("pending_approval") @db.VarChar(50)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy    String?  @map("created_by") @db.Uuid

  // Relations
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier       Supplier?        @relation(fields: [supplierId], references: [id])
  creator        User?            @relation(fields: [createdBy], references: [id])
  accountsPayable AccountPayable[]

  @@map("purchase_invoices")
}

model AccountPayable {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  supplierId        String   @map("supplier_id") @db.Uuid
  purchaseInvoiceId String?  @map("purchase_invoice_id") @db.Uuid
  
  // Document info
  documentType      String   @map("document_type") @db.VarChar(50)
  documentNumber    String?  @map("document_number") @db.VarChar(100)
  description       String
  
  // Values
  originalAmount    Decimal  @map("original_amount") @db.Decimal(15, 2)
  feesAmount        Decimal  @default(0) @map("fees_amount") @db.Decimal(15, 2)
  discountAmount    Decimal  @default(0) @map("discount_amount") @db.Decimal(15, 2)
  paidAmount        Decimal  @default(0) @map("paid_amount") @db.Decimal(15, 2)
  
  // Dates
  issueDate         DateTime? @map("issue_date") @db.Date
  dueDate           DateTime  @map("due_date") @db.Date
  paymentDate       DateTime? @map("payment_date") @db.Date
  
  // Payment info
  paymentMethod     String?   @map("payment_method") @db.VarChar(50)
  bankAccountId     String?   @map("bank_account_id") @db.Uuid
  installments      Int       @default(1)
  installmentNumber Int?      @map("installment_number")
  parentPayableId   String?   @map("parent_payable_id") @db.Uuid
  
  // Control
  costCenterId      String?   @map("cost_center_id") @db.Uuid
  projectId         String?   @map("project_id") @db.Uuid
  approvalStatus    String    @default("pending") @map("approval_status") @db.VarChar(50)
  approvalWorkflow  Json?     @map("approval_workflow") @db.JsonB
  paymentStatus     String    @default("pending") @map("payment_status") @db.VarChar(50)
  
  // Additional
  notes             String?
  tags              String[] @default([])
  attachments       Json     @default("[]") @db.JsonB
  
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy         String?  @map("created_by") @db.Uuid
  updatedBy         String?  @map("updated_by") @db.Uuid

  // Relations
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier          Supplier          @relation(fields: [supplierId], references: [id])
  purchaseInvoice   PurchaseInvoice?  @relation(fields: [purchaseInvoiceId], references: [id])
  parentPayable     AccountPayable?   @relation("PayableInstallments", fields: [parentPayableId], references: [id])
  installmentPayables AccountPayable[] @relation("PayableInstallments")
  creator           User?             @relation("AccountPayableCreatedBy", fields: [createdBy], references: [id])
  updater           User?             @relation("AccountPayableUpdatedBy", fields: [updatedBy], references: [id])
  paymentSchedules  PaymentSchedule[]

  @@map("accounts_payable")
}

model PaymentSchedule {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  payableId       String    @map("payable_id") @db.Uuid
  scheduledDate   DateTime  @map("scheduled_date") @db.Date
  amount          Decimal   @db.Decimal(15, 2)
  bankAccountId   String?   @map("bank_account_id") @db.Uuid
  status          String    @default("scheduled") @db.VarChar(50) // scheduled, processing, completed, failed
  batchId         String?   @map("batch_id") @db.Uuid
  errorMessage    String?   @map("error_message")
  processedAt     DateTime? @map("processed_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy       String?   @map("created_by") @db.Uuid

  // Relations
  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payable     AccountPayable @relation(fields: [payableId], references: [id])
  creator     User?          @relation(fields: [createdBy], references: [id])

  @@map("payment_schedules")
}

// =====================================================
// ACCOUNTS RECEIVABLE MODULE
// =====================================================

model Customer {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  customerType      String   @map("customer_type") @db.VarChar(20) // company, individual
  cnpjCpf           String   @map("cnpj_cpf") @db.VarChar(14)
  name              String   @db.VarChar(255)
  tradeName         String?  @map("trade_name") @db.VarChar(255)
  address           Json?    @db.JsonB
  contactInfo       Json?    @map("contact_info") @db.JsonB
  
  // Credit info
  creditLimit       Decimal  @default(0) @map("credit_limit") @db.Decimal(15, 2)
  creditUsed        Decimal  @default(0) @map("credit_used") @db.Decimal(15, 2)
  paymentTerms      Int      @default(30) @map("payment_terms")
  
  // Collections info
  collectionStatus  String   @default("normal") @map("collection_status") @db.VarChar(50)
  lastPurchaseDate  DateTime? @map("last_purchase_date") @db.Date
  totalPurchases    Decimal  @default(0) @map("total_purchases") @db.Decimal(15, 2)
  
  notes             String?
  tags              String[] @default([])
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  isActive          Boolean  @default(true) @map("is_active")

  // Relations
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  accountsReceivable  AccountReceivable[]
  salesInvoices       SalesInvoice[]

  @@unique([tenantId, cnpjCpf])
  @@map("customers")
}

model SalesInvoice {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  customerId        String   @map("customer_id") @db.Uuid
  
  // Invoice data
  invoiceNumber     String   @map("invoice_number") @db.VarChar(50)
  series            String?  @db.VarChar(10)
  nfeKey            String?  @unique @map("nfe_key") @db.VarChar(44)
  rpsNumber         String?  @map("rps_number") @db.VarChar(50)
  
  // Values
  servicesAmount    Decimal  @default(0) @map("services_amount") @db.Decimal(15, 2)
  productsAmount    Decimal  @default(0) @map("products_amount") @db.Decimal(15, 2)
  discountAmount    Decimal  @default(0) @map("discount_amount") @db.Decimal(15, 2)
  totalAmount       Decimal  @map("total_amount") @db.Decimal(15, 2)
  taxDetails        Json?    @map("tax_details") @db.JsonB
  
  // Dates and status
  issueDate         DateTime @map("issue_date") @db.Date
  competenceDate    DateTime? @map("competence_date") @db.Date
  status            String   @default("draft") @db.VarChar(50) // draft, authorized, cancelled
  cancellationReason String? @map("cancellation_reason")
  
  // Files
  xmlContent        String?  @map("xml_content")
  pdfUrl            String?  @map("pdf_url") @db.VarChar(500)
  
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy         String?  @map("created_by") @db.Uuid
  sentAt            DateTime? @map("sent_at") @db.Timestamptz(6)

  // Relations
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer            Customer            @relation(fields: [customerId], references: [id])
  creator             User?               @relation(fields: [createdBy], references: [id])
  accountsReceivable  AccountReceivable[]

  @@unique([tenantId, invoiceNumber, series])
  @@map("sales_invoices")
}

model AccountReceivable {
  id                  String   @id @default(uuid()) @db.Uuid
  tenantId            String   @map("tenant_id") @db.Uuid
  customerId          String   @map("customer_id") @db.Uuid
  salesInvoiceId      String?  @map("sales_invoice_id") @db.Uuid
  
  // Document info
  documentType        String   @map("document_type") @db.VarChar(50)
  documentNumber      String?  @map("document_number") @db.VarChar(100)
  description         String
  
  // Values
  originalAmount      Decimal  @map("original_amount") @db.Decimal(15, 2)
  feesAmount          Decimal  @default(0) @map("fees_amount") @db.Decimal(15, 2)
  discountAmount      Decimal  @default(0) @map("discount_amount") @db.Decimal(15, 2)
  receivedAmount      Decimal  @default(0) @map("received_amount") @db.Decimal(15, 2)
  
  // Dates
  issueDate           DateTime @map("issue_date") @db.Date
  dueDate             DateTime @map("due_date") @db.Date
  paymentDate         DateTime? @map("payment_date") @db.Date
  
  // Payment info
  paymentMethod       String?  @map("payment_method") @db.VarChar(50)
  bankSlipId          String?  @map("bank_slip_id") @db.Uuid
  pixQrCode           String?  @map("pix_qr_code")
  installments        Int      @default(1)
  installmentNumber   Int?     @map("installment_number")
  parentReceivableId  String?  @map("parent_receivable_id") @db.Uuid
  
  // Collection status
  collectionStatus    String   @default("pending") @map("collection_status") @db.VarChar(50)
  collectionActions   Json     @default("[]") @map("collection_actions") @db.JsonB
  protestStatus       String?  @map("protest_status") @db.VarChar(50)
  
  notes               String?
  tags                String[] @default([])
  
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy           String?  @map("created_by") @db.Uuid

  // Relations
  tenant                Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer              Customer           @relation(fields: [customerId], references: [id])
  salesInvoice          SalesInvoice?      @relation(fields: [salesInvoiceId], references: [id])
  parentReceivable      AccountReceivable? @relation("ReceivableInstallments", fields: [parentReceivableId], references: [id])
  installmentReceivables AccountReceivable[] @relation("ReceivableInstallments")
  creator               User?              @relation("AccountReceivableCreatedBy", fields: [createdBy], references: [id])
  bankSlips             BankSlip[]

  @@map("accounts_receivable")
}

model BankSlip {
  id                    String    @id @default(uuid()) @db.Uuid
  tenantId              String    @map("tenant_id") @db.Uuid
  receivableId          String    @map("receivable_id") @db.Uuid
  bankAccountId         String    @map("bank_account_id") @db.Uuid
  
  // Boleto info
  ourNumber             String    @map("our_number") @db.VarChar(50)
  bankSlipNumber        String?   @map("bank_slip_number") @db.VarChar(50)
  barCode               String?   @map("bar_code") @db.VarChar(54)
  digitableLine         String?   @map("digitable_line") @db.VarChar(54)
  
  // Values and dates
  amount                Decimal   @db.Decimal(15, 2)
  issueDate             DateTime  @map("issue_date") @db.Date
  dueDate               DateTime  @map("due_date") @db.Date
  paidDate              DateTime? @map("paid_date") @db.Date
  paidAmount            Decimal?  @map("paid_amount") @db.Decimal(15, 2)
  
  // Bank return
  occurrenceCode        String?   @map("occurrence_code") @db.VarChar(10)
  occurrenceDescription String?   @map("occurrence_description")
  bankFee               Decimal?  @map("bank_fee") @db.Decimal(15, 2)
  
  // Files and status
  pdfUrl                String?   @map("pdf_url") @db.VarChar(500)
  status                String    @default("issued") @db.VarChar(50) // issued, registered, paid, cancelled, protested
  
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  receivable   AccountReceivable @relation(fields: [receivableId], references: [id])

  @@map("bank_slips")
}

// =====================================================
// TREASURY MODULE
// =====================================================

model BankAccount {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  
  // Bank info
  bankCode          String   @map("bank_code") @db.VarChar(10)
  bankName          String   @map("bank_name") @db.VarChar(100)
  agencyNumber      String   @map("agency_number") @db.VarChar(10)
  agencyDigit       String?  @map("agency_digit") @db.VarChar(2)
  accountNumber     String   @map("account_number") @db.VarChar(20)
  accountDigit      String?  @map("account_digit") @db.VarChar(2)
  accountType       String   @map("account_type") @db.VarChar(20) // checking, savings, investment
  
  // Integration
  apiCredentials    Json?    @map("api_credentials") @db.JsonB
  syncEnabled       Boolean  @default(false) @map("sync_enabled")
  lastSyncAt        DateTime? @map("last_sync_at") @db.Timestamptz(6)
  
  // Balance
  currentBalance    Decimal  @default(0) @map("current_balance") @db.Decimal(15, 2)
  availableBalance  Decimal  @default(0) @map("available_balance") @db.Decimal(15, 2)
  blockedBalance    Decimal  @default(0) @map("blocked_balance") @db.Decimal(15, 2)
  
  // Config
  isMainAccount     Boolean  @default(false) @map("is_main_account")
  description       String?  @db.VarChar(255)
  tags              String[] @default([])
  
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  isActive          Boolean  @default(true) @map("is_active")

  // Relations
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cashFlowEntries   CashFlowEntry[]
  transfersFrom     BankTransfer[]   @relation("TransferFrom")
  transfersTo       BankTransfer[]   @relation("TransferTo")
  bankStatements    BankStatement[]
  bankTransactions  BankTransaction[]

  @@map("bank_accounts")
}

model CashFlowEntry {
  id                  String    @id @default(uuid()) @db.Uuid
  tenantId            String    @map("tenant_id") @db.Uuid
  bankAccountId       String    @map("bank_account_id") @db.Uuid
  
  // Transaction info
  entryDate           DateTime  @map("entry_date") @db.Date
  competenceDate      DateTime? @map("competence_date") @db.Date
  description         String
  
  // Values
  entryType           String    @map("entry_type") @db.VarChar(10) // inflow, outflow
  amount              Decimal   @db.Decimal(15, 2)
  balanceBefore       Decimal?  @map("balance_before") @db.Decimal(15, 2)
  balanceAfter        Decimal?  @map("balance_after") @db.Decimal(15, 2)
  
  // Classification
  categoryId          String?   @map("category_id") @db.Uuid
  subcategoryId       String?   @map("subcategory_id") @db.Uuid
  costCenterId        String?   @map("cost_center_id") @db.Uuid
  projectId           String?   @map("project_id") @db.Uuid
  
  // Reference
  referenceType       String?   @map("reference_type") @db.VarChar(50)
  referenceId         String?   @map("reference_id") @db.Uuid
  
  // Reconciliation
  isReconciled        Boolean   @default(false) @map("is_reconciled")
  reconciliationDate  DateTime? @map("reconciliation_date") @db.Date
  bankTransactionId   String?   @map("bank_transaction_id") @db.Uuid
  
  notes               String?
  attachments         Json      @default("[]") @db.JsonB
  
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy           String?   @map("created_by") @db.Uuid
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bankAccount BankAccount @relation(fields: [bankAccountId], references: [id])
  creator     User?       @relation(fields: [createdBy], references: [id])

  @@map("cash_flow_entries")
}

model CashFlowProjection {
  id                  String   @id @default(uuid()) @db.Uuid
  tenantId            String   @map("tenant_id") @db.Uuid
  projectionDate      DateTime @map("projection_date") @db.Date
  
  // Projected values
  beginningBalance    Decimal  @map("beginning_balance") @db.Decimal(15, 2)
  projectedInflows    Decimal  @default(0) @map("projected_inflows") @db.Decimal(15, 2)
  projectedOutflows   Decimal  @default(0) @map("projected_outflows") @db.Decimal(15, 2)
  
  // Breakdown
  receivablesDue      Decimal  @default(0) @map("receivables_due") @db.Decimal(15, 2)
  payablesDue         Decimal  @default(0) @map("payables_due") @db.Decimal(15, 2)
  recurringRevenue    Decimal  @default(0) @map("recurring_revenue") @db.Decimal(15, 2)
  recurringExpenses   Decimal  @default(0) @map("recurring_expenses") @db.Decimal(15, 2)
  
  // Actuals (updated daily)
  actualInflows       Decimal? @map("actual_inflows") @db.Decimal(15, 2)
  actualOutflows      Decimal? @map("actual_outflows") @db.Decimal(15, 2)
  actualBalance       Decimal? @map("actual_balance") @db.Decimal(15, 2)
  
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, projectionDate])
  @@map("cash_flow_projections")
}

model BankTransfer {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  
  // Accounts
  fromAccountId   String    @map("from_account_id") @db.Uuid
  toAccountId     String    @map("to_account_id") @db.Uuid
  
  // Transfer info
  transferDate    DateTime  @map("transfer_date") @db.Date
  amount          Decimal   @db.Decimal(15, 2)
  description     String?
  
  // Status
  status          String    @default("scheduled") @db.VarChar(50) // scheduled, processing, completed, failed
  errorMessage    String?   @map("error_message")
  
  // Cash flow references
  outflowEntryId  String?   @map("outflow_entry_id") @db.Uuid
  inflowEntryId   String?   @map("inflow_entry_id") @db.Uuid
  
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy       String?   @map("created_by") @db.Uuid
  processedAt     DateTime? @map("processed_at") @db.Timestamptz(6)

  // Relations
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  fromAccount BankAccount @relation("TransferFrom", fields: [fromAccountId], references: [id])
  toAccount   BankAccount @relation("TransferTo", fields: [toAccountId], references: [id])
  creator     User?       @relation(fields: [createdBy], references: [id])

  @@map("bank_transfers")
}

// =====================================================
// BANK RECONCILIATION MODULE
// =====================================================

model BankStatement {
  id                    String   @id @default(uuid()) @db.Uuid
  tenantId              String   @map("tenant_id") @db.Uuid
  bankAccountId         String   @map("bank_account_id") @db.Uuid
  
  // Statement info
  statementDate         DateTime @map("statement_date") @db.Date
  beginningBalance      Decimal  @map("beginning_balance") @db.Decimal(15, 2)
  endingBalance         Decimal  @map("ending_balance") @db.Decimal(15, 2)
  
  // Import info
  importType            String?  @map("import_type") @db.VarChar(50) // manual, ofx, api, cnab240
  importFileUrl         String?  @map("import_file_url") @db.VarChar(500)
  importedAt            DateTime @default(now()) @map("imported_at") @db.Timestamptz(6)
  importedBy            String?  @map("imported_by") @db.Uuid
  
  // Reconciliation status
  totalTransactions     Int      @default(0) @map("total_transactions")
  reconciledTransactions Int     @default(0) @map("reconciled_transactions")
  pendingTransactions   Int      @default(0) @map("pending_transactions")
  isClosed              Boolean  @default(false) @map("is_closed")

  // Relations
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bankAccount      BankAccount       @relation(fields: [bankAccountId], references: [id])
  importer         User?             @relation(fields: [importedBy], references: [id])
  bankTransactions BankTransaction[]

  @@unique([bankAccountId, statementDate])
  @@map("bank_statements")
}

model BankTransaction {
  id                   String    @id @default(uuid()) @db.Uuid
  tenantId             String    @map("tenant_id") @db.Uuid
  bankStatementId      String    @map("bank_statement_id") @db.Uuid
  bankAccountId        String    @map("bank_account_id") @db.Uuid
  
  // Transaction data
  transactionDate      DateTime  @map("transaction_date") @db.Date
  postingDate          DateTime? @map("posting_date") @db.Date
  description          String
  documentNumber       String?   @map("document_number") @db.VarChar(100)
  
  // Values
  transactionType      String    @map("transaction_type") @db.VarChar(10) // credit, debit
  amount               Decimal   @db.Decimal(15, 2)
  balance              Decimal?  @db.Decimal(15, 2)
  
  // Bank info
  bankCode             String?   @map("bank_code") @db.VarChar(50)
  transactionCode      String?   @map("transaction_code") @db.VarChar(50)
  
  // Reconciliation
  reconciliationStatus String    @default("pending") @map("reconciliation_status") @db.VarChar(50) // pending, matched, manual, ignored
  cashFlowEntryId      String?   @map("cash_flow_entry_id") @db.Uuid
  reconciledAt         DateTime? @map("reconciled_at") @db.Timestamptz(6)
  reconciledBy         String?   @map("reconciled_by") @db.Uuid
  
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bankStatement BankStatement @relation(fields: [bankStatementId], references: [id])
  bankAccount   BankAccount   @relation(fields: [bankAccountId], references: [id])
  reconciler    User?         @relation(fields: [reconciledBy], references: [id])

  @@map("bank_transactions")
}

model ReconciliationRule {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  
  ruleName          String   @map("rule_name") @db.VarChar(255)
  ruleType          String   @map("rule_type") @db.VarChar(50) // exact, contains, regex, amount_range
  
  // Conditions
  descriptionPattern String?  @map("description_pattern") @db.VarChar(500)
  amountMin         Decimal? @map("amount_min") @db.Decimal(15, 2)
  amountMax         Decimal? @map("amount_max") @db.Decimal(15, 2)
  transactionType   String?  @map("transaction_type") @db.VarChar(10)
  
  // Actions
  categoryId        String?  @map("category_id") @db.Uuid
  subcategoryId     String?  @map("subcategory_id") @db.Uuid
  autoReconcile     Boolean  @default(false) @map("auto_reconcile")
  
  priority          Int      @default(100)
  isActive          Boolean  @default(true) @map("is_active")
  
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy         String?  @map("created_by") @db.Uuid

  // Relations
  tenant  Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator User?  @relation(fields: [createdBy], references: [id])

  @@map("reconciliation_rules")
}

// =====================================================
// SUPPORTING MODELS
// =====================================================

model Category {
  id           String    @id @default(uuid()) @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  categoryType String    @map("category_type") @db.VarChar(50) // income, expense, cost_center, project
  parentId     String?   @map("parent_id") @db.Uuid
  
  code         String?   @db.VarChar(50)
  name         String    @db.VarChar(255)
  description  String?
  
  // Hierarchy
  path         String?
  level        Int       @default(0)
  
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  @@unique([tenantId, categoryType, code])
  @@map("categories")
}

model Attachment {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  
  // Reference
  entityType  String   @map("entity_type") @db.VarChar(50) // payable, receivable, invoice, etc
  entityId    String   @map("entity_id") @db.Uuid
  
  // File info
  fileName    String   @map("file_name") @db.VarChar(255)
  fileType    String?  @map("file_type") @db.VarChar(50)
  fileSize    Int?     @map("file_size")
  fileUrl     String   @map("file_url") @db.VarChar(500)
  
  // Metadata
  description String?
  uploadedBy  String?  @map("uploaded_by") @db.Uuid
  uploadedAt  DateTime @default(now()) @map("uploaded_at") @db.Timestamptz(6)

  // Relations
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploader User?  @relation(fields: [uploadedBy], references: [id])

  @@map("attachments")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  
  // What
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String   @map("entity_id") @db.Uuid
  action     String   @db.VarChar(50) // create, update, delete, approve, etc
  
  // Who and When
  userId     String   @map("user_id") @db.Uuid
  userEmail  String   @map("user_email") @db.VarChar(255)
  timestamp  DateTime @default(now()) @db.Timestamptz(6)
  
  // Details
  oldValues  Json?    @map("old_values") @db.JsonB
  newValues  Json?    @map("new_values") @db.JsonB
  ipAddress  String?  @map("ip_address") @db.Inet
  userAgent  String?  @map("user_agent")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model Notification {
  id         String    @id @default(uuid()) @db.Uuid
  tenantId   String    @map("tenant_id") @db.Uuid
  
  // Recipient
  userId     String    @map("user_id") @db.Uuid
  
  // Content
  type       String    @db.VarChar(50) // payment_due, approval_needed, etc
  title      String    @db.VarChar(255)
  message    String?
  
  // Reference
  entityType String?   @map("entity_type") @db.VarChar(50)
  entityId   String?   @map("entity_id") @db.Uuid
  actionUrl  String?   @map("action_url") @db.VarChar(500)
  
  // Status
  isRead     Boolean   @default(false) @map("is_read")
  readAt     DateTime? @map("read_at") @db.Timestamptz(6)
  
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@map("notifications")
}